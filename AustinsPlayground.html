<!DOCTYPE html>
<html>
<head>
	<title>Austin's Gender Dungeon</title>
	<script src="jQuery.txt"></script>
	<meta charset="utf-8"/>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<canvas id = "gameWin">
		If you can see this message,
		your web browser does not support Canvas.
	</canvas>
<script>
//centering game window
var pageW = window.innerWidth; //webpage width
var pageH = window.innerHeight; //webpage height
var $gWin = $("#gameWin");
var roomW = $gWin.width();
var roomH = $gWin.height();

console.log(roomW + " " + roomH);

$gWin.offset({left: (pageW - roomW)/2, top: (pageH - roomH)/2});

var winTop = $gWin.offset().top; //dist from top to game window
var winLeft = $gWin.offset().left;

//get the drawable part of the game window
var winCanvas = document.getElementById("gameWin");
winCanvas.width = roomW;
winCanvas.height = roomH;
var drawGameWin = winCanvas.getContext("2d");


var player =
{
	width: 40, height: 40,

	name: "Jessie",
	hitpoints: 10, attack: 10, speed: 10, light:100, hunger:150,

	//Movement stuff (-20 to center)
	x: roomW/2 - 20,
	y: roomH/2 - 20,

	movingNorth: false,
	movingSouth: false,
	movingEast: false,
	movingWest: false,
	//checks on player
	checkOnPlayer: function()
	{
		var deathCount = 0;
		if (player.hitpoints < 1)
		{
			while(player.hitpoints < 1)
			{
				var randomCheck = Math.random();
				if (randomCheck < 1/2)
				{
					player.speed = player.speed - 1;
				}
				else
				{
					player.attack = player.attack - 1;
				}
				player.hitpoints = player.hitpoints + 1;
			}
			deathCount = deathCount + 3;
		}
		if (player.speed < 0)
		{
			//immobile
			deathCount = deathCount + 1;
		}
		if (player.attack < 0)
		{
			//playerCripple
			deathCount = deathCount + 1;
		}
		if (deathCount > 4)
		{
			//playerdeath
		}
	},
	lightCheck: function()
	{
		if (player.light < 1)
		{
			//-1 hp every second!
		}
	},
	foodCheck: function()
	{
		if (player.hunger > 150)
		{
			//lowers speed overall(not the stat)! ate too much!
		}
		else if (player.hunger == 125)
		{
			// "I could use a light snack."
		}
		else if (player.hunger == 100)
		{
			// "An appitizer would be nice."
		}
		else if (player.hunger == 75)
		{
			// "I think that rumbling is my stomach."
		}
		else if (player.hunger == 50)
		{
			// "I am starving!"
		}
		else if (player.hunger < 50)
		{
			//your maximum for a speed/attack is normal if hunger > 50, otherwise it is
			//equal to hunger / 5 but does not cause you to lose the stat value.
			//for example, Alex has 34 hunger left but a 9 stat for speed. His speed
			//is not lowered to 6, but his movment is the same as if it was 6.
			//aka he would move as fast as Alexa with a speed of 6 and any hunger value >= 30.
			if (player.hunger < 10)
			{
				//the only exeption to this rule is health, once your hunger reaches below 10
				//one loses a health every 5 seconds!
			}
		}
	},

	//moves players x/y
	draw: function()
	{
		//TODO: fix diagonal fast moving bug
		var dx = 1.5; var dy = 1.5;

		if (player.movingNorth) player.y -= dy;
		if (player.movingEast) player.x += dx;
		if (player.movingSouth) player.y += dy;
		if (player.movingWest) player.x -= dx;

		var roomDoors = world[roomX][roomY].doors;
		if( player.y < 0 ) //top wall
		{
			player.y = 0; //make sure player doesn't go past
			var nDoor = roomDoors.north;
			if ( nDoor != null && nDoor.inDoor())
			{
				nDoor.goThru();
			}
		}
		if( player.x + player.width > roomW ) //right wall
		{
			player.x = roomW - player.width;
			var eDoor = roomDoors.east;
			if (eDoor != null && eDoor.inDoor())
			{
				eDoor.goThru();
			}
		}
		if( player.y + player.height > roomH ) //bottom wall
		{
			player.y = roomH - player.height;
			var sDoor = roomDoors.south;
			if (sDoor != null && sDoor.inDoor())
			{
				sDoor.goThru();
			}
		}
		if( player.x < 0 ) //left wall
		{
			player.x = 0;
			wDoor = roomDoors.west;
			if (wDoor != null && wDoor.inDoor())
			{
				wDoor.goThru();
			}
		}

		drawGameWin.fillStyle = "red";
		drawGameWin.fillRect(player.x, player.y, player.width, player.height);
		drawGameWin.fillStyle = "black";
		drawGameWin.fillRect(10, 10, 200, 10);
		drawGameWin.fillStyle = "red";
		drawGameWin.fillRect(10, 10, player.hitpoints * 200 / 10, 10);
		drawGameWin.font= "20px Arial";
		drawGameWin.fillStyle = "black";
		drawGameWin.fillText("Attack " + player.attack, 10, 40);
		drawGameWin.fillText("Speed " + player.speed, 10, 65);
	}
};

//doors
function Door(x, y)
{
	console.log("new door at " + x + ", " + y);
	this.x = x;
	this.y = y;
	this.width = 100;
	this.height = 100;

	//function inDoor()
	//function goThru()

	this.draw = function()
	{
		drawGameWin.fillStyle = "brown";
		drawGameWin.fillRect(this.x, this.y, this.width, this.height);
	}
}

function newNorthDoor()
{
	var door = new Door(roomW/2, 0);
	door.x -= door.width/2;
	door.height = 10;
	door.inDoor = function()
	{
		return player.x > door.x && //left
			player.x + player.width < door.x + door.width; //right
	}
	door.goThru = function()
	{
		player.y = roomH - player.height; //move to south wall
		roomY--;
		generateRoom(roomX, roomY);
	}
	return door;
}

function newSouthDoor()
{
	var door = newNorthDoor();
	door.y = roomH - door.height;
	door.goThru = function()
	{
		player.y = 0; //move to north wall
		roomY++;
		generateRoom(roomX, roomY);
	}
	return door;
}

function newEastDoor()
{
	var door = newWestDoor();
	door.x = roomW - door.width;
	door.goThru = function()
	{
		player.x = 0; //move to west wall
		roomX++;
		generateRoom(roomX, roomY);
	}
	return door;
}

function newWestDoor()
{
	var door = new Door(0, roomH/2);
	door.y -= door.height/2;
	door.width = 10;
	door.inDoor = function()
	{
		return player.y > door.y && //top
			player.y + player.height < door.y + door.height; //bottom
	}
	door.goThru = function()
	{
		player.x = roomW - player.width; //move to east wall
		roomX--;
		generateRoom(roomX, roomY);
	}
	return door;
}


//rooms
function Room()
{
	this.doors = {north: null, east: null, south: null, west: null};
	this.draw = function()
	{
		//draw background
		drawGameWin.fillStyle = "grey";
		drawGameWin.fillRect(0, 0, 600, 600);

		for (direction in this.doors)
		{
			door = this.doors[direction];
			if (door != null)
			{
				door.draw();
			}
		}
	}
	//TODO: move generateRoom() in here
}

//world
var maxX = 20;
var maxY = 20;

var world = new Array(maxX);
for (i = 0; i < maxX; i++)
{
	world[i] = new Array(maxY);
}

//start room
var roomX = Math.floor(maxX/2);
var roomY = Math.floor(maxY/2);

var start = world[roomX][roomY] = new Room();
start.doors.north = newNorthDoor();
start.doors.east = newEastDoor();
start.doors.south = newSouthDoor();
start.doors.west = newWestDoor();

//generates a room by checking doors of adjacent rooms.
function generateRoom(x, y)
{
	if (world[x][y] != null)
	{
		//don't need to generate room
		console.log("Load room at " + x + ", " + y);
		return false;
	}

	var newRoom = new Room();
	var newDoors = newRoom.doors;

	//north
	if (y > 0) //if room above exists
	{
		var roomAbove = world[x][y-1];
		if ( roomAbove != null ? roomAbove.doors.south != null : randDoor() )
			newDoors.north = newNorthDoor();
	}

	//east
	if (x < maxX - 1) //if room right exists
	{
		var roomRight = world[x+1][y];
		if ( roomRight != null ? roomRight.doors.west != null : randDoor() )
			newDoors.east = newEastDoor();
	}

	//south
	if (y < maxY - 1) //if room below exists
	{
		var roomBelow = world[x][y+1];
		if ( roomBelow != null ? roomBelow.doors.north != null : randDoor() )
			newDoors.south = newSouthDoor();
	}

	//west
	if (x > 0) //if room left exists
	{
		var roomLeft = world[x-1][y];
		if ( roomLeft != null ? roomLeft.doors.east != null : randDoor() )
			newDoors.west = newWestDoor();

	}

	console.log("New room generated at " + x + ", " + y);
	world[x][y] = newRoom;
	return true;
}

//40% of time returns true
function randDoor()
{
	//console.log("randDoor()");
	return Math.random() < 0.40;
}



$("body").keydown(onDown);
$("body").keyup(onUp);
//when button are pressed, change the movement to true
function onDown(event)
{
	//console.log("down: " + event.keyCode);
	switch(event.keyCode)
	{
		case 87: //w
			player.movingNorth = true;
			break;
		case 65: //a
			player.movingWest = true;
			break;
		case 83: //s
			player.movingSouth = true;
			break;
		case 68: //d
			player.movingEast = true;
			break;
	}

}

//undo the button
function onUp(event)
{
	//console.log("up: " + event.keyCode);
	switch(event.keyCode)
	{
		case 87: //w
			player.movingNorth = false;
			break;
		case 65: //a
			player.movingWest = false;
			break;
		case 83: //s
			player.movingSouth = false;
			break;
		case 68: //d
			player.movingEast = false;
			break;
	}
}



function updateImage()
{
	//draw room
	world[roomX][roomY].draw();
	player.draw();
}

setInterval(updateImage, 1);
</script>
</body>
</html>
